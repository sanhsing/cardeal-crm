# ============================================
# è»Šè¡Œå¯¶ CRM v5.1 - Docker Compose
# åŒ—æ–—ä¸ƒæ˜Ÿæ–‡å‰µæ•¸ä½ Ã— ç¹”æ˜
# ============================================

version: '3.8'

services:
  # ä¸»æ‡‰ç”¨
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cardeal-crm
    restart: unless-stopped
    ports:
      - "${PORT:-10000}:10000"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - ENV=${ENV:-production}
      - DEBUG=${DEBUG:-false}
      - PORT=10000
      - DATA_DIR=/app/data
      # LINE è¨­å®š
      - LINE_CHANNEL_SECRET=${LINE_CHANNEL_SECRET:-}
      - LINE_CHANNEL_ACCESS_TOKEN=${LINE_CHANNEL_ACCESS_TOKEN:-}
      # ECPay è¨­å®š
      - ECPAY_MERCHANT_ID=${ECPAY_MERCHANT_ID:-}
      - ECPAY_HASH_KEY=${ECPAY_HASH_KEY:-}
      - ECPAY_HASH_IV=${ECPAY_HASH_IV:-}
      - ECPAY_TEST_MODE=${ECPAY_TEST_MODE:-true}
      # Telegram è¨­å®š
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:10000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # å‚™ä»½æœå‹™ï¼ˆå¯é¸ï¼‰
  backup:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cardeal-backup
    restart: "no"
    volumes:
      - ./data:/app/data
      - ./backups:/backups
    environment:
      - DATA_DIR=/app/data
    entrypoint: ["python", "-c", "from services.backup_service import backup_all; backup_all()"]
    profiles:
      - backup

# æŒä¹…åŒ–å·
volumes:
  data:
  logs:

# ç¶²è·¯
networks:
  default:
    name: cardeal-network


# ğŸ“š çŸ¥è­˜é»
# -----------
# 1. version: '3.8'ï¼š
#    - Compose æª”æ¡ˆç‰ˆæœ¬
#    - æ±ºå®šå¯ç”¨åŠŸèƒ½
#
# 2. restart: unless-stoppedï¼š
#    - è‡ªå‹•é‡å•Ÿï¼ˆé™¤éæ‰‹å‹•åœæ­¢ï¼‰
#    - é©åˆç”Ÿç”¢ç’°å¢ƒ
#
# 3. volumesï¼š
#    - æŒä¹…åŒ–è³‡æ–™
#    - å®¹å™¨é‡å»ºå¾Œè³‡æ–™ä¸ä¸Ÿå¤±
#
# 4. environmentï¼š
#    - ${VAR:-default}ï¼šç’°å¢ƒè®Šæ•¸æˆ–é è¨­å€¼
#    - å¾ .env è®€å–
#
# 5. healthcheckï¼š
#    - å®¹å™¨å…§å¥åº·æª¢æŸ¥
#    - é…åˆ restart è‡ªå‹•æ¢å¾©
#
# 6. loggingï¼š
#    - json-fileï¼šæ¨™æº– JSON æ—¥èªŒ
#    - max-size/max-fileï¼šæ—¥èªŒè¼ªæ›¿
#
# 7. profilesï¼š
#    - å¯é¸æœå‹™
#    - docker-compose --profile backup up
