# ============================================
# è»Šè¡Œå¯¶ CRM v5.1 - GitHub Actions CI
# åŒ—æ–—ä¸ƒæ˜Ÿæ–‡å‰µæ•¸ä½ Ã— ç¹”æ˜
# ============================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # èªæ³•æª¢æŸ¥
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Syntax Check
        run: |
          find . -name "*.py" -type f | while read f; do
            python -m py_compile "$f" || exit 1
          done
          echo "âœ… All Python files passed syntax check"

  # å–®å…ƒæ¸¬è©¦
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short
      
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 7

  # å»ºç½® Docker æ˜ åƒ
  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t cardeal-crm:${{ github.sha }} .
          docker build -t cardeal-crm:latest .
      
      - name: Test Docker image
        run: |
          docker run -d --name test-app -p 10000:10000 cardeal-crm:latest
          sleep 5
          curl -f http://localhost:10000/api/health || exit 1
          docker stop test-app
          echo "âœ… Docker image health check passed"

  # é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    if: always()
    steps:
      - name: Notify Telegram
        if: env.TELEGRAM_BOT_TOKEN != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ needs.build.result }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="âœ…"
            MESSAGE="CI é€šé"
          else
            EMOJI="âŒ"
            MESSAGE="CI å¤±æ•—"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${EMOJI} *è»Šè¡Œå¯¶ CRM CI*%0A${MESSAGE}%0ABranch: ${{ github.ref_name }}%0ACommit: ${{ github.sha }}"


# ğŸ“š çŸ¥è­˜é»
# -----------
# 1. on: push/pull_requestï¼š
#    - è§¸ç™¼æ¢ä»¶
#    - branches æŒ‡å®šåˆ†æ”¯
#
# 2. jobs ä¾è³´ï¼š
#    - needs: lint è¡¨ç¤ºä¾è³´ lint job
#    - å¯å»ºç«‹ DAG å·¥ä½œæµ
#
# 3. actions/checkout@v4ï¼š
#    - æª¢å‡ºç¨‹å¼ç¢¼
#    - @v4 æŒ‡å®šç‰ˆæœ¬
#
# 4. if æ¢ä»¶ï¼š
#    - github.event_nameï¼šäº‹ä»¶é¡å‹
#    - github.refï¼šåˆ†æ”¯å¼•ç”¨
#
# 5. secretsï¼š
#    - å„²å­˜æ•æ„Ÿè³‡è¨Š
#    - åœ¨ GitHub è¨­å®šä¸­é…ç½®
#
# 6. artifactsï¼š
#    - ä¿å­˜æ¸¬è©¦å ±å‘Š
#    - retention-daysï¼šä¿ç•™å¤©æ•¸
