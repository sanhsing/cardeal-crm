# è»Šè¡Œå¯¶ CRM v5.2 - CD æŒçºŒéƒ¨ç½²
# åŒ—æ–—ä¸ƒæ˜Ÿæ–‡å‰µæ•¸ä½ Ã— ç¹”æ˜

name: CD

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      deploy_env:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================
  # 1. æ¸¬è©¦éšæ®µ
  # ============================================================
  test:
    name: ğŸ§ª æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: ğŸ§ª Run tests
      run: |
        python -m pytest tests/ --ignore=tests/test_e2e.py -q \
          --cov=handlers --cov=services --cov=models \
          --cov-fail-under=40
      env:
        TESTING: 'true'
    
    - name: âœ… Tests passed
      run: echo "All tests passed!"

  # ============================================================
  # 2. éƒ¨ç½²åˆ° Render
  # ============================================================
  deploy:
    name: ğŸš€ éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸš€ Deploy to Render
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}
    
    - name: â³ Wait for deployment
      run: sleep 120
    
    - name: ğŸ” Health check
      run: |
        for i in {1..5}; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://cardeal-crm.onrender.com/api/system/health || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Health check passed!"
            exit 0
          fi
          echo "Attempt $i: Status $STATUS, retrying..."
          sleep 30
        done
        echo "âŒ Health check failed"
        exit 1

  # ============================================================
  # 3. é€šçŸ¥
  # ============================================================
  notify:
    name: ğŸ“¢ é€šçŸ¥
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: ğŸ“¢ Telegram notification
      if: env.TELEGRAM_BOT_TOKEN != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        STATUS="${{ needs.deploy.result }}"
        if [ "$STATUS" = "success" ]; then
          EMOJI="âœ…"
          MESSAGE="éƒ¨ç½²æˆåŠŸ"
        else
          EMOJI="âŒ"
          MESSAGE="éƒ¨ç½²å¤±æ•—"
        fi
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d parse_mode="Markdown" \
          -d text="${EMOJI} *è»Šè¡Œå¯¶ CRM* ${MESSAGE}

ğŸ“¦ Commit: \`${GITHUB_SHA:0:7}\`
ğŸ‘¤ Author: ${{ github.actor }}
ğŸ”— [View Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
