# ============================================
# è»Šè¡Œå¯¶ CRM v5.1 - GitHub Actions CD
# åŒ—æ–—ä¸ƒæ˜Ÿæ–‡å‰µæ•¸ä½ Ã— ç¹”æ˜
# ============================================

name: CD

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run tests
        run: |
          pip install -r requirements.txt
          pip install pytest
          python -m pytest tests/ -v --tb=short
      
      # Render éƒ¨ç½²ï¼ˆè‡ªå‹•è§¸ç™¼ï¼‰
      - name: Deploy to Render
        if: env.RENDER_DEPLOY_HOOK_URL != ''
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          curl -X POST "$RENDER_DEPLOY_HOOK_URL"
          echo "âœ… Render deployment triggered"
      
      # Docker Hub ç™¼å¸ƒï¼ˆå¯é¸ï¼‰
      - name: Login to Docker Hub
        if: env.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker image
        if: env.DOCKER_USERNAME != ''
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          docker build -t ${{ secrets.DOCKER_USERNAME }}/cardeal-crm:${VERSION} .
          docker build -t ${{ secrets.DOCKER_USERNAME }}/cardeal-crm:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/cardeal-crm:${VERSION}
          docker push ${{ secrets.DOCKER_USERNAME }}/cardeal-crm:latest
      
      # é€šçŸ¥
      - name: Notify Telegram
        if: always() && env.TELEGRAM_BOT_TOKEN != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          STATUS="${{ job.status }}"
          
          if [ "$STATUS" = "success" ]; then
            EMOJI="ğŸš€"
            MESSAGE="éƒ¨ç½²æˆåŠŸ"
          else
            EMOJI="âŒ"
            MESSAGE="éƒ¨ç½²å¤±æ•—"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${EMOJI} *è»Šè¡Œå¯¶ CRM éƒ¨ç½²*%0A${MESSAGE}%0AVersion: ${VERSION}%0AEnvironment: ${{ github.event.inputs.environment || 'production' }}"


# ğŸ“š çŸ¥è­˜é»
# -----------
# 1. on: push: tagsï¼š
#    - åªåœ¨æ¨é€ tag æ™‚è§¸ç™¼
#    - v* åŒ¹é… v1.0, v5.1.0 ç­‰
#
# 2. workflow_dispatchï¼š
#    - æ‰‹å‹•è§¸ç™¼
#    - inputs å®šç¾©åƒæ•¸
#
# 3. environmentï¼š
#    - GitHub Environments
#    - å¯è¨­å®šä¿è­·è¦å‰‡
#
# 4. GITHUB_REFï¼š
#    - refs/tags/v5.1.0
#    - ${GITHUB_REF#refs/tags/} å–å¾— v5.1.0
#
# 5. Render Deploy Hookï¼š
#    - Render æä¾›çš„ webhook URL
#    - POST è«‹æ±‚è§¸ç™¼éƒ¨ç½²
